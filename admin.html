<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Admin Carta Tilo CafÃ©</title>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f7f7f7;
    }
    h1 {
        text-align: center;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: #fff;
    }
    table th, table td {
        border: 1px solid #ccc;
        padding: 6px;
        font-size: 14px;
        text-align: left;
    }
    table th {
        background: #ead2c3;
    }
    img.mini {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 5px;
    }
    #preview {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 10px;
        display: block;
        margin-bottom: 10px;
    }
    #formNuevo, #formVarios {
        background: #fff;
        padding: 15px;
        border-radius: 10px;
        margin-top: 20px;
        border: 1px solid #ccc;
    }
    .btn {
        background: #a07b68;
        color: white;
        padding: 8px 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin: 4px;
        font-size: 14px;
    }
    .btn:hover {
        opacity: 0.8;
    }
    #toastOK {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 12px 18px;
        border-radius: 6px;
        font-weight: bold;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        z-index: 3000;
    }
</style>
</head>
<body>

<h1>ADMINISTRADOR DE CARTA</h1>

<div id="toastOK">Cambios guardados correctamente</div>

<div>
    <label><b>Token:</b></label>
    <input type="password" id="tokenInput" style="width:260px;">
    <button class="btn" onclick="guardarToken()">Guardar Token</button>
</div>

<button class="btn" onclick="mostrarFormNuevo()">+ Agregar Producto</button>
<button class="btn" onclick="mostrarFormVarios()">Agregar VARIOS</button>
<button class="btn" style="float:right;" onclick="guardarTodos()">ðŸ’¾ Guardar TODOS los cambios</button>

<table>
    <thead>
        <tr>
            <th>ID</th>
            <th>IMG</th>
            <th>Nombre</th>
            <th>DescripciÃ³n</th>
            <th>Precio</th>
            <th>CategorÃ­a</th>
            <th>Guardar</th>
        </tr>
    </thead>
    <tbody id="tablaBody"></tbody>
</table>

<!-- Formulario para agregar producto -->
<div id="formNuevo" style="display:none;">
    <h3>Agregar Producto</h3>
    <img src="" id="preview">
    <input id="nNombre" placeholder="Nombre"><br><br>
    <input id="nDesc" placeholder="DescripciÃ³n"><br><br>
    <input id="nPrecio" placeholder="Precio" type="number"><br><br>
    <input id="nCat" placeholder="CategorÃ­a"><br><br>
    <input id="nImg" placeholder="Nombre de imagen (sin 'img/')"><br><br>
    <button class="btn" onclick="agregarUno()">Agregar</button>
    <button class="btn" onclick="cerrarFormNuevo()">Cerrar</button>
</div>

<!-- Formulario para agregar VARIOS -->
<div id="formVarios" style="display:none;">
    <h3>Agregar VARIOS</h3>
    <textarea id="multiTxt" style="width:100%;height:150px;"></textarea><br>
    <button class="btn" onclick="procesarVarios()">Procesar</button>
    <button class="btn" onclick="cerrarFormVarios()">Cerrar</button>
</div>

<script>
/* ==========================
       CONFIGURACIÃ“N
=========================== */
const USERNAME = "sequispe";
const REPO     = "carta";
const MAIN_JSON = "productos.json"; 
const EN_JSON   = "productos-en.json";
const PT_JSON   = "productos-port.json";

let TOKEN = localStorage.getItem("githubToken") || "";
document.getElementById("tokenInput").value = TOKEN;

let productos = [];
let productosEN = [];
let productosPT = [];

/* ==========================
         TOAST
=========================== */
function showOK(msg="Cambios guardados") {
    const t = document.getElementById("toastOK");
    t.textContent = msg;
    t.style.opacity = "1";
    setTimeout(() => t.style.opacity = "0", 3000);
}

/* ==========================
        TOKEN
=========================== */
function guardarToken() {
    TOKEN = document.getElementById("tokenInput").value.trim();
    if (TOKEN.length < 5) return alert("Token invÃ¡lido.");
    localStorage.setItem("githubToken", TOKEN);
    showOK("Token guardado");
}

/* ==========================
    CARGA DESDE GITHUB
=========================== */
async function getFile(path) {
    const url = `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}`;
    const r = await fetch(url);
    const j = await r.json();
    return JSON.parse(atob(j.content));
}

/* ==========================
    GUARDAR EN GITHUB
=========================== */
async function saveFile(path, data) {
    const url = `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}`;
    const r = await fetch(url);
    const file = await r.json();
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(data,null,2))));
    await fetch(url, {
        method: "PUT",
        headers: {
            "Authorization": `Bearer ${TOKEN}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            message: "Update " + path,
            content: content,
            sha: file.sha
        })
    });
    return true;
}

/* ==========================
      MOSTRAR TABLA
=========================== */
function renderTabla() {
    let html = "";
    productos.forEach((p,i) => {
        html += `
        <tr>
            <td>${p.id}</td>
            <td><img src="img/${p.img}" class="mini"></td>
            <td><input value="${p.nombre}" onchange="cambiar(${i},'nombre',this.value)"></td>
            <td><input value="${p.descripcion}" onchange="cambiar(${i},'descripcion',this.value)"></td>
            <td><input value="${p.precio}" type="number" onchange="cambiar(${i},'precio',this.value)"></td>
            <td><input value="${p.categoria}" onchange="cambiar(${i},'categoria',this.value)"></td>
            <td><button class="btn" onclick="guardarFila(${i})">Guardar</button></td>
        </tr>`;
    });
    document.getElementById("tablaBody").innerHTML = html;
}

function cambiar(i,campo,v) {
    productos[i][campo] = v;
    sincronizarOtros(i);
}

function sincronizarOtros(i) {
    let id = productos[i].id;
    let itemEN = productosEN.find(p=>p.id==id);
    let itemPT = productosPT.find(p=>p.id==id);
    if(itemEN){ itemEN.precio = productos[i].precio; }
    if(itemPT){ itemPT.precio = productos[i].precio; }
}

/* ==========================
        GUARDAR FILA
=========================== */
async function guardarFila(i) {
    await saveFile(MAIN_JSON, productos);
    await saveFile(EN_JSON, productosEN);
    await saveFile(PT_JSON, productosPT);
    showOK("Fila guardada");
}

/* ==========================
    GUARDAR TODOS LOS CAMBIOS
=========================== */
async function guardarTodos() {
    await saveFile(MAIN_JSON, productos);
    await saveFile(EN_JSON, productosEN);
    await saveFile(PT_JSON, productosPT);
    showOK("Todos los cambios guardados");
}

/* ==========================
    AGREGAR PRODUCTO (UNO)
=========================== */
function mostrarFormNuevo(){ document.getElementById("formNuevo").style.display="block";}
function cerrarFormNuevo(){  document.getElementById("formNuevo").style.display="none";}

function agregarUno(){
    const nombre = nNombre.value.trim();
    if(!nombre) return alert("Nombre vacÃ­o");

    let ultimo = productos[productos.length-1];
    let n = parseInt(ultimo.id.replace("id","")) + 1;
    let nuevoID = "id" + String(n).padStart(4,"0");

    let obj = {
        id: nuevoID,
        nombre: nNombre.value,
        descripcion: nDesc.value,
        precio: nPrecio.value,
        categoria: nCat.value,
        img: nImg.value
    };

    productos.push(obj);
    productosEN.push({...obj});
    productosPT.push({...obj});

    renderTabla();
    showOK("Producto agregado");
}

/* ==========================
   AGREGAR VARIOS PRODUCTOS
=========================== */
function mostrarFormVarios(){ document.getElementById("formVarios").style.display="block";}
function cerrarFormVarios(){  document.getElementById("formVarios").style.display="none";}

function procesarVarios(){
    let lineas = multiTxt.value.trim().split("\n");
    let ultimo = productos[productos.length-1];
    let n = parseInt(ultimo.id.replace("id","")) + 1;

    lineas.forEach(l=>{
        let partes = l.split("|");
        if(partes.length<5) return;

        let nuevoID = "id"+String(n).padStart(4,"0");
        n++;

        let obj = {
            id: nuevoID,
            nombre: partes[0],
            descripcion: partes[1],
            precio: partes[2],
            categoria: partes[3],
            img: partes[4]
        };

        productos.push(obj);
        productosEN.push({...obj});
        productosPT.push({...obj});
    });

    renderTabla();
    showOK("Productos agregados");
}

/* ==========================
          INICIO
=========================== */
async function init(){
    productos   = await getFile(MAIN_JSON);
    productosEN = await getFile(EN_JSON);
    productosPT = await getFile(PT_JSON);
    renderTabla();
}
init();

</script>
</body>
</html>
