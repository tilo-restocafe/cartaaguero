<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Carta - Tilo Caf√© Ag√ºero</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f3f0; color:#333; }
    h1 { text-align:center; color:#806250; }
    #toggleForm { background:#806250; color:white; padding:10px 15px; border-radius:6px; cursor:pointer; margin-bottom:15px; }
    form { display:none; background:#fff; padding:15px; border-radius:10px; margin-bottom:20px; }
    input, textarea { width:100%; padding:8px; margin:7px 0; border-radius:6px; border:1px solid #ccc; }
    table { width:100%; border-collapse:collapse; background:white; }
    th,td { border:1px solid #ddd; padding:8px; }
    th { background:#806250; color:white; }
    button { background:#806250; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .btn-delete { background:#c0392b; }
    #preview { max-width:100px; margin-top:5px; border-radius:6px; }
    #hoverPreview { position: fixed; top: 0; left: 0; width: 220px; display:none; border:2px solid #806250; border-radius:10px; background:#fff; z-index:9999; box-shadow:0 0 10px rgba(0,0,0,0.3); padding:6px; }
    td input, td textarea { width:95%; }
    td img.mini-img { cursor: pointer; }
  </style>
</head>
<body>
  <h1>Panel de Administraci√≥n</h1>

<button id="btnGuardarGlobal" onclick="guardarCambiosGlobales()" style="position:absolute; top:20px; right:20px; background:#4CAF50; color:white; padding:10px 15px; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">üíæ Guardar TODOS los cambios</button>

  <div>
    <label>Token:</label>
    <input type="password" id="token" placeholder="Pegar token">
    <button onclick="saveToken()">Guardar</button>
    <button onclick="clearToken()">Borrar</button>
    <p id="tokenStatus"></p>
  </div>

  <input id="search" placeholder="Buscar..." oninput="filterProducts()">

  <button id="toggleForm" onclick="toggleForm()">+ Agregar producto</button>
<button id="agregarVarios" onclick="toggleMultiForm()" style="margin-left:10px; background:#5c8a50;">‚ûï Agregar VARIOS</button>

  <form id="form">
    <input type="hidden" id="editIndex">
    <label>Nombre</label>
    <input id="nombre">

    <label>Descripci√≥n</label>
    <textarea id="descripcion"></textarea>

    <label>Precio</label>
    <input id="precio">

    <label>Imagen (img/...)</label>
    <input id="imagen" oninput="previewImage()">
    <img id="preview">

    <label>Categor√≠a</label>
    <input id="categoria">

    <button type="button" onclick="guardarFormulario()">Guardar</button>
  </form>

<!-- FORMULARIO M√öLTIPLE -->
<form id="multiForm" style="display:none; background:#fff; padding:15px; border-radius:10px; margin-bottom:20px;">
  <h3>Cargar varios productos</h3>
  <p>Agreg√° un producto por l√≠nea con este formato:</p>
  <p><b>nombre | descripcion | precio | imagen | categoria</b></p>
  <textarea id="multiInput" placeholder="Ej:\nCaf√© expresso | Caf√© chico | 3400 | img/cafe.jpg | Cafeter√≠a" style="height:180px;"></textarea>
  <button type="button" onclick="procesarMulti()">Guardar varios</button>
</form>

  <table>
    <thead><tr>
      <th>Imagen</th><th>Nombre</th><th>Descripci√≥n</th><th>Categor√≠a</th><th>Precio</th><th>Acciones</th>
    </tr></thead>
    <tbody id="tbody"></tbody>
  </table>

<button id="guardarTodos" onclick="guardarTodosLosPrecios()" style="margin-top:15px; padding:10px 15px; background:#a07b68; color:white; border:none; border-radius:8px; cursor:pointer;">üíæ Guardar TODOS los precios</button>

<script>
const USERNAME="cholose10", REPO="cartaaguero";
const MAIN_JSON="productos.json";          // espa√±ol
const EN_JSON="productos-en.json";         // ingl√©s
const PT_JSON="productos-por.json";        // portugu√©s

let productos=[];

function saveToken(){ const t=document.getElementById('token').value; localStorage.setItem('github_token',t); document.getElementById('tokenStatus').innerText='Token guardado'; }
function clearToken(){ localStorage.removeItem('github_token'); document.getElementById('tokenStatus').innerText='Token borrado'; }
function getToken(){ return localStorage.getItem('github_token'); }

async function loadProducts(){
  try{
    const url=`https://raw.githubusercontent.com/${USERNAME}/${REPO}/main/${MAIN_JSON}`;
    const r=await fetch(url);
    productos=await r.json();
    render(productos);
  }catch(e){ console.error('Error cargando productos',e); productos=[]; render(productos); }
}

function render(lista){
  const tb=document.getElementById('tbody'); tb.innerHTML='';
  lista.forEach((p,i)=>{
    tb.innerHTML+=`\
      <tr>\
        <td><img src="${p.imagen||''}" class="mini-img" style="max-width:60px;"></td>\
        <td><input value="${escapeHtml(p.nombre||'')}" oninput="editField(${i},'nombre',this.value)"></td>\
        <td><textarea oninput="editField(${i},'descripcion',this.value)">${escapeHtml(p.descripcion||'')}</textarea></td>\
        <td><input value="${escapeHtml(p.categoria||'')}" oninput="editField(${i},'categoria',this.value)"></td>\
        <td><input type="text" value="${p.precio||''}" oninput="editField(${i},'precio',this.value)"></td>\
        <td>\
          <button onclick="guardarFila(${i})">Guardar</button>\
        </td>\
      </tr>`;
  });
}

function escapeHtml(text){ return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function editField(i,campo,valor){
  productos[i] = productos[i] || {};
  productos[i][campo] = valor;
}

// Guardar por fila (se mantiene por compatibilidad, pero recomendamos usar el guardado global)
async function guardarFila(i){
  alert('Ahora el guardado es global üëâ Us√° el bot√≥n "Guardar TODOS los cambios" arriba a la derecha.');
  // Si en alg√∫n caso quiere activar guardado por fila, descomentar y ajustar:
  // const p = productos[i];
  // const ok = await saveToGitHub(MAIN_JSON, productos);
  // if(!ok){ alert("Error guardando ES"); return; }
  // await syncPrice(p.id, p.precio);
  // alert("Cambios guardados correctamente (ES + precios EN/PT)");
}

async function syncPrice(id, precio){
  if(!id) return;
  await updatePriceInJSON(EN_JSON, id, precio);
  await updatePriceInJSON(PT_JSON, id, precio);
}

async function updatePriceInJSON(file, id, precio){
  try{
    const url=`https://raw.githubusercontent.com/${USERNAME}/${REPO}/main/${file}`;
    const r=await fetch(url);
    if(!r.ok) { console.warn('No existe archivo',file); return; }
    let arr = await r.json();

    const index = arr.findIndex(x=>x.id===id);
    if(index>=0){ arr[index].precio = precio; }

    await saveToGitHub(file, arr);
  }catch(e){ console.error('Error updatePriceInJSON',file,e); }
}

async function saveToGitHub(fileName, content){
  try{
    const token=getToken(); if(!token){ alert("Falta token"); return false; }

    let sha = null;
    try{ sha = await getSHA(fileName); }catch(e){ console.warn('No se pudo obtener SHA, el archivo puede no existir. Se crear√° uno nuevo.'); }

    const res = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${fileName}`,{
      method:'PUT',
      headers:{'Content-Type':'application/json','Authorization':`token ${token}`},
      body:JSON.stringify({
        message:'update',
        content:btoa(unescape(encodeURIComponent(JSON.stringify(content,null,2)))),
        ...(sha?{sha}:{})
      })
    });

    if(!res.ok){ const t = await res.text(); console.error('GitHub API error',t); }
    return res.ok;
  }catch(e){ console.error(e); return false; }
}

async function getSHA(file){
  const r=await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${file}`);
  const j=await r.json(); if(!r.ok) throw new Error('No SHA'); return j.sha;
}

// Inicializar carga
loadProducts();

function toggleMultiForm(){
  const f=document.getElementById('multiForm');
  f.style.display = f.style.display==='none'? 'block':'none';
}

// Fix: use a valid regex to split lines (handle CRLF and multiple blank lines)
async function procesarMulti(){
  const txt=document.getElementById('multiInput').value.trim();
  if(!txt){ alert('No hay datos'); return; }

  const lineas = txt.split(/\r?\n+/);
  let nuevos=[];

  for(const linea of lineas){
    if(!linea.trim()) continue;
    const partes=linea.split('|').map(x=>x.trim());
    if(partes.length!==5){ alert('L√≠nea con formato incorrecto: '+ linea); return; }

    const [nombre, descripcion, precio, imagen, categoria] = partes;

    // generar ID autom√°tico (busca √∫ltimo n√∫mero disponible en productos existentes)
    const maxId = productos.reduce((m,it)=>{ const match = (it.id||'').match(/prod(\d+)/); return match? Math.max(m, parseInt(match[1],10)) : m; }, 0);
    const newIndex = maxId + nuevos.length + 1;
    const id = 'prod' + String(newIndex).padStart(4,'0');

    nuevos.push({ nombre, descripcion, precio, imagen, categoria, id });
  }

  // Agregar al array principal
  productos = productos.concat(nuevos);

  // Guardar en ES
  const ok = await saveToGitHub(MAIN_JSON, productos);
  if(!ok){ alert('Error guardando en ES'); return; }

  // Sincronizar precios en EN/PT
  for(const p of nuevos){
    await syncPrice(p.id, p.precio);
  }

  alert('‚úî Productos cargados correctamente');
  document.getElementById('multiInput').value='';
  loadProducts();
}

async function guardarCambiosGlobales(){
  if(!confirm('¬øGuardar TODOS los cambios realizados en la tabla?')) return;

  // Guardar ES completo
  const ok = await saveToGitHub(MAIN_JSON, productos);
  if(!ok){ alert('‚ùå Error guardando el archivo principal (ES)'); return; }

  // Actualizar SOLO precios en EN y PT
  for(const p of productos){ await syncPrice(p.id, p.precio); }

  alert('‚úî Todos los cambios guardados correctamente (ES completo + precios EN/PT)');
}

async function guardarTodosLosPrecios(){
  if(!confirm("¬øGuardar TODOS los precios? Esto actualizar√° ES, EN y PT.")) return;

  // 1) Guardar productos.json (ES)
  const ok = await saveToGitHub(MAIN_JSON, productos);
  if(!ok){ alert("‚ùå Error guardando en ES"); return; }

  // 2) Sincronizar todos los precios en EN y PT
  for(const p of productos){
    await syncPrice(p.id, p.precio);
  }

  alert("‚úî Todos los precios guardados en ES y sincronizados en EN/PT");
}

// --- funciones adicionales para el formulario simple ---
function toggleForm(){
  const f = document.getElementById('form');
  f.style.display = f.style.display==='none' || f.style.display===''? 'block':'none';
}

function previewImage(){
  const src = document.getElementById('imagen').value;
  const img = document.getElementById('preview');
  if(!src){ img.style.display='none'; img.src=''; return; }
  img.style.display='block'; img.src = src;
}

async function guardarFormulario(){
  const nombre = document.getElementById('nombre').value.trim();
  const descripcion = document.getElementById('descripcion').value.trim();
  const precio = document.getElementById('precio').value.trim();
  const imagen = document.getElementById('imagen').value.trim();
  const categoria = document.getElementById('categoria').value.trim();

  if(!nombre){ alert('Falta nombre'); return; }

  // generar id
  const maxId = productos.reduce((m,it)=>{ const match = (it.id||'').match(/prod(\d+)/); return match? Math.max(m, parseInt(match[1],10)) : m; }, 0);
  const id = 'prod' + String(maxId + 1).padStart(4,'0');

  const nuevo = { nombre, descripcion, precio, imagen, categoria, id };
  productos.push(nuevo);

  const ok = await saveToGitHub(MAIN_JSON, productos);
  if(!ok){ alert('Error guardando ES'); return; }

  // sincronizar precio
  await syncPrice(nuevo.id, nuevo.precio);

  alert('Producto agregado correctamente');
  document.getElementById('form').reset();
  document.getElementById('preview').src='';
  loadProducts();
}

// simple filter
function filterProducts(){
  const q = document.getElementById('search').value.toLowerCase();
  const filtered = productos.filter(p=> (p.nombre||'').toLowerCase().includes(q) || (p.descripcion||'').toLowerCase().includes(q) || (p.categoria||'').toLowerCase().includes(q));
  render(filtered);
}
</script>
<img id="hoverPreview" />
</body>
</html>
