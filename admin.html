<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tilo CafÃ© - Admin</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fafafa;
      margin: 0;
      padding: 0;
    }
    header {
      background: #333;
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-size: 1.4rem;
    }
    main {
      padding: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: white;
      border-radius: 6px;
      overflow: hidden;
    }
    th {
      background: #444;
      color: #fff;
      padding: 8px;
      text-align: left;
    }
    td {
      border-bottom: 1px solid #ccc;
      padding: 6px;
    }
    td img {
      width: 60px;
      height: auto;
      border-radius: 4px;
    }
    button {
      background: #008cba;
      border: none;
      color: #fff;
      padding: 6px 12px;
      font-size: 0.9rem;
      border-radius: 4px;
      cursor: pointer;
      margin: 2px;
    }
    button:hover {
      background: #0074a1;
    }
    .danger {
      background: #c0392b;
    }
    .danger:hover {
      background: #a52f23;
    }
    .success {
      background: #27ae60;
    }
    .success:hover {
      background: #1f8a4d;
    }

    /* FORM */
    #formAgregar {
      margin-top: 2rem;
      background: white;
      padding: 1rem;
      border-radius: 6px;
      box-shadow: 0px 2px 4px rgba(0,0,0,0.2);
    }
    #formAgregar input,
    #formAgregar select {
      display: block;
      padding: 8px;
      width: 100%;
      margin-bottom: 10px;
      font-size: 1rem;
    }

    /* TOAST VERDE */
    #toastOK {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #2ecc71;
      color: white;
      padding: 12px 18px;
      font-weight: bold;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <header>
    <h1>Administrador Tilo CafÃ©</h1>
  </header>

  <!-- TOAST -->
  <div id="toastOK">Cambios guardados correctamente</div>

  <main>
    <button onclick="guardarTodosLosPrecios()" class="success">ðŸ’¾ Guardar TODOS los cambios</button>

    <table id="tabla">
      <thead>
        <tr>
          <th>ID</th>
          <th>Imagen</th>
          <th>Nombre</th>
          <th>DescripciÃ³n</th>
          <th>CategorÃ­a</th>
          <th>Precio</th>
          <th>Guardar</th>
          <th>Borrar</th>
        </tr>
      </thead>
      <tbody id="tbodyProductos"></tbody>
    </table>

    <h2>Agregar producto nuevo</h2>
    <form id="formAgregar">
      <input type="text" id="newNombre" placeholder="Nombre ES">
      <input type="text" id="newDescripcion" placeholder="DescripciÃ³n ES">
      <input type="text" id="newCategoria" placeholder="CategorÃ­a">
      <input type="number" id="newPrecio" placeholder="Precio">
      <input type="text" id="newImg" placeholder="Nombre de imagen (ej: latte.jpg)">
      <button type="button" onclick="agregarProducto()">Agregar producto</button>
    </form>
  </main>

<script>
// -------------------- TOAST --------------------
function showToastOK(msg = "Cambios guardados correctamente") {
  const t = document.getElementById("toastOK");
  t.textContent = msg;
  t.style.opacity = "1";
  setTimeout(() => { t.style.opacity = "0"; }, 3000);
}

// -------------------- GLOBAL --------------------
let productosES = [];
let productosEN = [];
let productosPT = [];
const MAIN = "productos.json";
const ENG = "productos_en.json";
const PT = "productos_pt.json";

// -------------------- CARGA INICIAL --------------------
async function loadJSON(file) {
  const r = await fetch(file + "?v=" + Date.now());
  return await r.json();
}

async function cargarTodo() {
  productosES = await loadJSON(MAIN);
  productosEN = await loadJSON(ENG);
  productosPT = await loadJSON(PT);
  renderTabla();
}

cargarTodo();

// -------------------- RENDER TABLA --------------------
function renderTabla() {
  const tbody = document.getElementById("tbodyProductos");
  tbody.innerHTML = "";

  productosES.forEach((p, i) => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${p.id}</td>
      <td><img src="img/${p.img}" /></td>
      <td><input id="name${i}" value="${p.nombre}"></td>
      <td><input id="desc${i}" value="${p.descripcion}"></td>
      <td><input id="cat${i}" value="${p.categoria}"></td>
      <td><input id="price${i}" type="number" value="${p.precio}"></td>
      <td><button onclick="guardarFila(${i})">ðŸ’¾</button></td>
      <td><button class="danger" onclick="borrar(${i})">ðŸ—‘</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// -------------------- GUARDAR FILA --------------------
async function guardarFila(i) {
  const p = productosES[i];

  p.nombre = document.getElementById("name" + i).value;
  p.descripcion = document.getElementById("desc" + i).value;
  p.categoria = document.getElementById("cat" + i).value;
  p.precio = Number(document.getElementById("price" + i).value);

  let en = productosEN.find(e => e.id === p.id);
  let pt = productosPT.find(e => e.id === p.id);

  if (en) en.precio = p.precio;
  if (pt) pt.precio = p.precio;

  await saveAllJSON();
  showToastOK("Fila guardada");
}

// -------------------- BORRAR FILA --------------------
async function borrar(i) {
  if (!confirm("Â¿Seguro que deseas borrar este producto?")) return;

  const id = productosES[i].id;

  productosES = productosES.filter(p => p.id !== id);
  productosEN = productosEN.filter(p => p.id !== id);
  productosPT = productosPT.filter(p => p.id !== id);

  renderTabla();
  await saveAllJSON();
  showToastOK("Producto eliminado");
}

// -------------------- GUARDAR TODOS --------------------
async function guardarTodosLosPrecios() {
  await saveAllJSON();
  showToastOK("Todos los cambios guardados");
}

// -------------------- AGREGAR PRODUCTO --------------------
function generarID() {
  let nums = productosES.map(p => Number(p.id.replace("id", "")));
  let max = Math.max(...nums);
  let next = (max + 1).toString().padStart(4, "0");
  return "id" + next;
}

async function agregarProducto() {
  const nombre = newNombre.value;
  const descripcion = newDescripcion.value;
  const categoria = newCategoria.value;
  const precio = Number(newPrecio.value);
  const img = newImg.value;

  const nuevo = {
    id: generarID(),
    nombre, descripcion, categoria, precio, img
  };

  productosES.push({ ...nuevo });
  productosEN.push({ ...nuevo });
  productosPT.push({ ...nuevo });

  renderTabla();
  await saveAllJSON();
  showToastOK("Producto agregado");
}

// -------------------- GUARDAR JSON EN GITHUB --------------------
async function saveAllJSON() {
  await Promise.all([
    uploadJSON(MAIN, productosES),
    uploadJSON(ENG, productosEN),
    uploadJSON(PT, productosPT)
  ]);
}

// -------------------- SUBIDA SIMPLE (local) --------------------
async function uploadJSON(file, data) {
  await fetch(file, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data, null, 2)
  });
}
</script>
</body>
</html>
