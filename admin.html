<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Carta - Tilo Caf√© Ag√ºero</title>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:18px;background:#f7f3f0;color:#333}
    h1{text-align:center;color:#806250;margin-bottom:10px}

    .topRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px}

    .controls{display:flex;gap:8px;align-items:center}

    input[type="text"], input[type="password"], textarea{
      padding:8px;border-radius:6px;border:1px solid #ccc;width:100%;box-sizing:border-box
    }

    button{
      background:#806250;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer
    }
    button.danger{background:#c0392b}

    form{background:#fff;padding:12px;border-radius:10px;margin-bottom:12px;display:none}

    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{border:1px solid #ddd;padding:8px;vertical-align:top}
    th{background:#806250;color:#fff}

    img.mini{max-width:60px;border-radius:6px}

    .rowActions{display:flex;gap:6px}

    .previewImg{max-width:120px;margin-top:8px;border-radius:6px}

    /* POSICI√ìN NUEVA DEL BOT√ìN */
    #guardarTodos{
      position:fixed;
      bottom:20px;
      right:20px;
      z-index:1200;
      padding:12px 18px;
      font-size:15px;
      background:#a07b68;
      color:#fff;
      border-radius:10px;
      box-shadow:0 3px 10px rgba(0,0,0,.2);
    }

    /* TOAST */
    .toast{
      position:fixed;top:24px;right:24px;z-index:2000;padding:12px 16px;border-radius:8px;
      color:white;font-weight:600;box-shadow:0 6px 18px rgba(0,0,0,0.15);
      opacity:0;transform:translateY(-10px);
      transition:opacity .25s ease,transform .25s ease;
      max-width:360px;
    }
    .toast.show{opacity:1;transform:translateY(0)}
    .toast.ok{background:#2ecc71}
    .toast.info{background:#3498db}
    .toast.err{background:#e74c3c}

  </style>
</head>
<body>

  <!-- BANNER DE BLOQUEO -->
  <div id="lockBanner"
       style="display:none;
              background:#e74c3c;
              color:white;
              text-align:center;
              padding:12px;
              font-size:18px;
              font-weight:bold;
              border-radius:6px;
              margin-bottom:14px;">
    PANEL BLOQUEADO ‚Äî Peg√° el token para habilitar edici√≥n
  </div>

  <h1>Tilo Caf√© Ag√ºero ‚Äî Panel Admin</h1>

  <div class="topRow">
    <div style="flex:1">
      <div style="margin-bottom:6px">
        <span style="font-size:13px;color:#666">Repositorio:</span> 
        <b>cholose10 / cartaaguero</b>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <label style="min-width:40px">Token:</label>
        <input type="password" id="token" placeholder="Pegar token de GitHub (repo contents)"
               style="max-width:420px">
        <button onclick="saveToken()">Guardar</button>
        <button onclick="clearToken()">Borrar</button>
        <span style="font-size:13px;color:#666" id="tokenStatus">No guardado</span>
      </div>
    </div>

    <div class="controls">
      <input id="search" placeholder="Buscar..." oninput="filterProducts()"
             style="min-width:180px;max-width:360px">
      <button onclick="toggleForm()">+ Agregar producto</button>
      <!-- ELIMINADO AGREGAR VARIOS -->
    </div>
  </div>

  <!-- BOT√ìN REUBICADO ABAJO -->
  <button id="guardarTodos" onclick="guardarTodosLosPrecios()">
    üíæ Guardar TODOS los cambios
  </button>

  <!-- Formulario -->
  <form id="form">
    <input type="hidden" id="editIndex">

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <label>Nombre</label>
        <input id="nombre" type="text">
      </div>

      <div>
        <label>Precio</label>
        <input id="precio" type="text" placeholder="Ej: 3400 (sin $)">
      </div>

      <div style="grid-column:1/3">
        <label>Descripci√≥n</label>
        <textarea id="descripcion" rows="3"></textarea>
      </div>

      <div>
        <label>Imagen</label>
        <input id="imagen" type="text" oninput="previewImage()">
        <img id="preview" class="previewImg" style="display:none">
      </div>

      <div>
        <label>Categor√≠a</label>
        <input id="categoria" type="text">
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px">
      <button type="button" onclick="guardarFormulario()">Guardar</button>
      <button type="button" onclick="cancelForm()" style="background:#999">Cancelar</button>
    </div>
  </form>

  <!-- TABLA -->
  <table>
    <thead>
      <tr>
        <th style="width:80px">Imagen</th>
        <th>Nombre</th>
        <th>Descripci√≥n</th>
        <th>Categor√≠a</th>
        <th style="width:100px">Precio</th>
        <th style="width:180px">Acciones</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>


<script>
/*******************************************************
 * CONFIG
 *******************************************************/
const USERNAME = "cholose10";
const REPO = "cartaaguero";
const BRANCH = "main";

const MAIN_JSON = "productos.json";
const EN_JSON   = "productos-en.json";
const PT_JSON   = "productos-port.json";

let productos = [];

/*******************************************************
 * TOAST
 *******************************************************/
function showToast(msg, variant='ok', timeout=3000){
  const div = document.createElement('div');
  div.className = 'toast ' + (variant==='info'?'info':variant==='err'?'err':'ok');
  div.innerText = (variant==='err'?'‚úñ ':'‚úî ') + msg;
  document.body.appendChild(div);

  requestAnimationFrame(()=>div.classList.add('show'));
  setTimeout(()=>{
    div.classList.remove('show');
    setTimeout(()=>div.remove(),300);
  },timeout);
}

/*******************************************************
 * TOKEN
 *******************************************************/
function saveToken(){
  const t = document.getElementById('token').value.trim();
  if(!t){ showToast("Peg√° tu token", "err"); return; }
  localStorage.setItem("github_token", t);
  document.getElementById("tokenStatus").innerText = "Token guardado";
  checkTokenAndLock();
}

function clearToken(){
  localStorage.removeItem("github_token");
  document.getElementById("tokenStatus").innerText = "No guardado";
  checkTokenAndLock();
}

function getToken(){ return localStorage.getItem("github_token"); }

/*******************************************************
 * BLOQUEO M√ìDULO 14
 *******************************************************/
function lockAdmin(locked){
  const disabled = locked;

  document.querySelectorAll("input, textarea").forEach(el=>{
    if(el.id === "token") return;
    el.disabled = disabled;
  });

  document.querySelectorAll("button").forEach(btn=>{
    const t = btn.innerText.toLowerCase();
    if(
      t.includes("guardar") ||
      t.includes("agregar") ||
      t.includes("eliminar") ||
      btn.id === "guardarTodos"
    ){
      btn.disabled = disabled;
      btn.style.opacity = disabled ? "0.5":"1";
    }
  });
}

function checkTokenAndLock(){
  const token = getToken();
  const banner = document.getElementById("lockBanner");

  if(!token){
    lockAdmin(true);
    banner.style.display="block";
  }else{
    lockAdmin(false);
    banner.style.display="none";
  }
}

/*******************************************************
 * UTILIDADES
 *******************************************************/
function extractNumberFromProdId(id){
  if(!id) return null;
  const m = String(id).match(/(\d+)$/);
  return m ? parseInt(m[1],10) : null;
}

function generateNextProdId(){
  let max = 0;
  productos.forEach(p=>{
    const n = extractNumberFromProdId(p.id||"");
    if(n && n>max) max=n;
  });
  return "prod" + String(max+1).padStart(4,"0");
}

function sanitizePrice(v){
  return String(v).replace(/[^\d]/g,"");
}

/*******************************************************
 * ORDENAR CAMPOS POR IDIOMA
 *******************************************************/
function ordenarCamposPorIdioma(item, idioma){
  const id = item.id || "";

  if(idioma==="EN"){
    return {
      id:id,
      name:item.nombre||"",
      description:item.descripcion||"",
      price:item.precio||"",
      image:item.imagen||"",
      category:item.categoria||""
    };
  }

  if(idioma==="PT"){
    return {
      nome:item.nombre||"",
      descricao:item.descripcion||"",
      preco:item.precio||"",
      imagem:item.imagen||"",
      categoria:item.categoria||"",
      id:id
    };
  }

  return {
    nombre:item.nombre||"",
    descripcion:item.descripcion||"",
    precio:item.precio||"",
    imagen:item.imagen||"",
    categoria:item.categoria||"",
    id:id
  };
}

/*******************************************************
 * CARGAR productos.json
 *******************************************************/
async function loadProducts(){
  try{
    const r = await fetch(`https://raw.githubusercontent.com/${USERNAME}/${REPO}/${BRANCH}/${MAIN_JSON}`);
    const arr = await r.json();
    productos = arr.map(item=>({
      id:item.id,
      nombre:item.nombre,
      descripcion:item.descripcion,
      precio:String(item.precio),
      imagen:item.imagen,
      categoria:item.categoria
    }));
    render(productos);
  }catch(e){
    showToast("No se pudo cargar productos.json", "err", 4000);
  }
}

/*******************************************************
 * RENDER TABLA
 *******************************************************/
function render(lista){
  const tb = document.getElementById("tbody");
  tb.innerHTML="";

  lista.forEach((p,i)=>{
    const tr = document.createElement("tr");

    // imagen
    const tdImg = document.createElement("td");
    const img = document.createElement("img");
    img.className="mini";
    img.src = p.imagen || "";
    img.onerror = ()=> img.style.display="none";
    tdImg.appendChild(img);
    tr.appendChild(tdImg);

    // nombre
    const tdNom=document.createElement("td");
    const iNom=document.createElement("input");
    iNom.value=p.nombre;
    iNom.oninput=e=>productos[i].nombre=e.target.value;
    tdNom.appendChild(iNom);
    tr.appendChild(tdNom);

    // descripci√≥n
    const tdD=document.createElement("td");
    const iDesc=document.createElement("textarea");
    iDesc.rows=2;
    iDesc.value=p.descripcion;
    iDesc.oninput=e=>productos[i].descripcion=e.target.value;
    tdD.appendChild(iDesc);
    tr.appendChild(tdD);

    // categor√≠a
    const tdC=document.createElement("td");
    const iCat=document.createElement("input");
    iCat.value=p.categoria;
    iCat.oninput=e=>productos[i].categoria=e.target.value;
    tdC.appendChild(iCat);
    tr.appendChild(tdC);

    // precio
    const tdP=document.createElement("td");
    const iPre=document.createElement("input");
    iPre.value=p.precio;
    iPre.oninput=e=>productos[i].precio=e.target.value;
    tdP.appendChild(iPre);
    tr.appendChild(tdP);

    // acciones
    const tdAcc=document.createElement("td");
    tdAcc.className="rowActions";

    const b1=document.createElement("button");
    b1.textContent="Guardar";
    b1.onclick=()=>guardarFila(i);

    const b2=document.createElement("button");
    b2.textContent="Editar";
    b2.style.background="#2d87d6";
    b2.onclick=()=>loadIntoForm(i);

    const b3=document.createElement("button");
    b3.textContent="Eliminar";
    b3.className="danger";
    b3.onclick=()=>eliminarProducto(i);

    tdAcc.append(b1,b2,b3);
    tr.appendChild(tdAcc);

    tb.appendChild(tr);
  });
}

/*******************************************************
 * FORMULARIO
 *******************************************************/
function toggleForm(){
  const f=document.getElementById("form");
  f.style.display = f.style.display==="none"||f.style.display===""?"block":"none";
}

function cancelForm(){
  document.getElementById("editIndex").value="";
  document.getElementById("nombre").value="";
  document.getElementById("descripcion").value="";
  document.getElementById("precio").value="";
  document.getElementById("imagen").value="";
  document.getElementById("categoria").value="";
  document.getElementById("preview").style.display="none";
  document.getElementById("form").style.display="none";
}

function previewImage(){
  const v=document.getElementById("imagen").value.trim();
  const img=document.getElementById("preview");
  if(!v){ img.style.display="none"; return; }
  img.src=v;
  img.style.display="block";
}

function loadIntoForm(i){
  const p=productos[i];
  document.getElementById("editIndex").value=i;
  document.getElementById("nombre").value=p.nombre;
  document.getElementById("descripcion").value=p.descripcion;
  document.getElementById("precio").value=p.precio;
  document.getElementById("imagen").value=p.imagen;
  document.getElementById("categoria").value=p.categoria;
  previewImage();
  document.getElementById("form").style.display="block";
}

function guardarFormulario(){
  const idx=document.getElementById("editIndex").value;
  const nombre=document.getElementById("nombre").value.trim();
  const descripcion=document.getElementById("descripcion").value.trim();
  const precio=sanitizePrice(document.getElementById("precio").value.trim());
  const imagen=document.getElementById("imagen").value.trim();
  const categoria=document.getElementById("categoria").value.trim();

  if(idx!==""){
    productos[idx] = {...productos[idx], nombre, descripcion, precio, imagen, categoria};
  }else{
    productos.push({
      id:generateNextProdId(),
      nombre, descripcion, precio, imagen, categoria
    });
  }

  render(productos);
  cancelForm();
  showToast("Producto guardado localmente");
}

/*******************************************************
 * ELIMINAR
 *******************************************************/
function eliminarProducto(i){
  if(!confirm("Eliminar producto?")) return;
  productos.splice(i,1);
  render(productos);
}

/*******************************************************
 * REFRESCAR TABLA
 *******************************************************/
function refrescarArrayDesdeTabla(){
  const filas = document.querySelectorAll("#tbody tr");
  const nuevos=[];

  filas.forEach((fila,i)=>{
    const td=fila.querySelectorAll("td");
    nuevos.push({
      id:productos[i].id,
      imagen:productos[i].imagen,
      nombre:td[1].querySelector("input").value.trim(),
      descripcion:td[2].querySelector("textarea").value.trim(),
      categoria:td[3].querySelector("input").value.trim(),
      precio:sanitizePrice(td[4].querySelector("input").value.trim())
    });
  });

  productos = nuevos;
}

/*******************************************************
 * GITHUB (M√ìDULO 1 ‚Äî SHA FRESCO)
 *******************************************************/
async function githubGetFileInfo(path){
  const token=getToken();
  const headers = token ? 
    {Authorization:"token "+token} :
    {};
  const url = `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}?ref=${BRANCH}`;

  const r = await fetch(url,{headers});
  if(!r.ok) throw new Error("Error GET "+path);
  return await r.json();
}

async function githubPutFile(path, content, message, sha){
  const token=getToken();
  const body={
    message,
    content:btoa(unescape(encodeURIComponent(content))),
    branch:BRANCH
  };
  if(sha) body.sha=sha;

  const r = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}`,{
    method:"PUT",
    headers:{
      Authorization:"token "+token,
      "Content-Type":"application/json"
    },
    body:JSON.stringify(body)
  });

  const data = await r.json();
  if(!r.ok) throw new Error(`PUT ${path}: ${data.message}`);
  return data;
}

/*******************************************************
 * GUARDAR MAIN
 *******************************************************/
async function saveMainJson(arr, msg){
  const out = arr.map(x=>ordenarCamposPorIdioma(x,"ES"));
  const txt = JSON.stringify(out,null,2);

  let sha = null;
  try{ sha = (await githubGetFileInfo(MAIN_JSON)).sha; }catch(e){}

  // SHA fresco
  try{ sha = (await githubGetFileInfo(MAIN_JSON)).sha; }catch(e){}

  return githubPutFile(MAIN_JSON, txt, msg, sha);
}

/*******************************************************
 * SYNC EN + PT
 *******************************************************/
async function syncPricesToLangs(){
  const map={};
  productos.forEach(p=>map[p.id]=p.precio);

  async function proc(file, lang){
    let info=null, arr=[];
    try{
      info=await githubGetFileInfo(file);
      const raw=decodeURIComponent(escape(window.atob(info.content.replace(/\n/g,""))));
      arr=JSON.parse(raw);
    }catch(e){ arr=[]; }

    let changed=false;

    const nuevo = arr.map(item=>{
      if(map[item.id]){
        const np = map[item.id];
        if(item.price!==undefined && item.price!==np){ item.price=np; changed=true; }
        if(item.preco!==undefined && item.preco!==np){ item.preco=np; changed=true; }
        if(item.precio!==undefined && item.precio!==np){ item.precio=np; changed=true; }
      }
      return ordenarCamposPorIdioma(item, lang);
    });

    if(!changed) return;

    const shaFresh = (await githubGetFileInfo(file)).sha;
    const txt = JSON.stringify(nuevo,null,2);
    await githubPutFile(file,txt,"Sync precios",shaFresh);
  }

  await proc(EN_JSON,"EN");
  await proc(PT_JSON,"PT");
}

/*******************************************************
 * GUARDAR FILA
 *******************************************************/
async function guardarFila(i){
  try{
    productos[i].precio = sanitizePrice(productos[i].precio);
    await saveMainJson(productos,"Actualiza producto "+productos[i].id);
    await syncPricesToLangs();
    showToast("Guardado OK");
  }catch(e){
    showToast(e.message,"err",5000);
  }
}

/*******************************************************
 * GUARDAR TODOS
 *******************************************************/
async function guardarTodosLosPrecios(){
  try{
    refrescarArrayDesdeTabla();
    await saveMainJson(productos,"Guardar TODOS");
    await syncPricesToLangs();
    showToast("Cambios guardados correctamente");
  }catch(e){
    showToast(e.message,"err",5000);
  }
}

/*******************************************************
 * FILTRO
 *******************************************************/
function filterProducts(){
  const q=document.getElementById("search").value.toLowerCase();
  if(!q){ render(productos); return; }

  render(
    productos.filter(p =>
      p.nombre.toLowerCase().includes(q) ||
      p.descripcion.toLowerCase().includes(q) ||
      p.categoria.toLowerCase().includes(q)
    )
  );
}

/*******************************************************
 * INIT
 *******************************************************/
document.addEventListener("DOMContentLoaded",()=>{
  checkTokenAndLock();
  loadProducts();
});
</script>

</body>
</html>
