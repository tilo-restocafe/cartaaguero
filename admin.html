<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Carta - Tilo Caf√© Ag√ºero</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:18px;background:#f7f3f0;color:#333}
    h1{text-align:center;color:#806250;margin-bottom:10px}
    .topRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px}
    .controls{display:flex;gap:8px;align-items:center}
    input[type="text"], input[type="password"], textarea{padding:8px;border-radius:6px;border:1px solid #ccc;width:100%;box-sizing:border-box}
    button{background:#806250;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
    button.secondary{background:#5c8a50}
    button.danger{background:#c0392b}
    form{background:#fff;padding:12px;border-radius:10px;margin-bottom:12px;display:none}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{border:1px solid #ddd;padding:8px;vertical-align:top}
    th{background:#806250;color:#fff}
    img.mini{max-width:60px;border-radius:6px}
    #guardarTodos{position:fixed;top:18px;right:18px;z-index:1200;padding:10px 14px;background:#a07b68;color:#fff;border-radius:8px}
    .small{font-size:13px;color:#666}
    .rowActions{display:flex;gap:6px}
    .previewImg{max-width:120px;margin-top:8px;border-radius:6px}
    textarea#multiInput{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}

    /* Toast variants */
    .toast {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 2000;
      padding: 12px 16px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity .25s ease, transform .25s ease;
      max-width: 360px;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.ok { background: #2ecc71; }
    .toast.info { background: #3498db; }
    .toast.err { background: #e74c3c; }
    @media(max-width:720px){ .topRow{flex-direction:column;align-items:flex-start} table{font-size:13px} }
  </style>
</head>
<body>

  <h1>Panel de Administraci√≥n - Tilo Caf√© Ag√ºero</h1>

  <div class="topRow">
    <div style="flex:1">
      <div style="margin-bottom:6px"><span class="small">Repositorio:</span> <b>cholose10 / cartaaguero</b></div>
      <div style="display:flex;gap:8px;align-items:center">
        <label style="min-width:40px">Token:</label>
        <input type="password" id="token" placeholder="Pegar token de GitHub (repo contents)" style="max-width:420px">
        <button onclick="saveToken()">Guardar</button>
        <button onclick="clearToken()">Borrar</button>
        <span class="small" id="tokenStatus" style="margin-left:8px">No guardado</span>
      </div>
    </div>

    <div class="controls">
      <input id="search" placeholder="Buscar..." oninput="filterProducts()" style="min-width:180px;max-width:360px">
      <button id="toggleFormBtn" onclick="toggleForm()">+ Agregar producto</button>
      <button class="secondary" onclick="toggleMultiForm()">‚ûï Agregar VARIOS</button>
    </div>
  </div>

  <!-- BOT√ìN FIJO para guardar todo -->
  <button id="guardarTodos" onclick="guardarTodosLosPrecios()">üíæ Guardar TODOS los cambios</button>

  <!-- FORMULARIO SIMPLE AGREGAR / EDITAR -->
  <form id="form">
    <input type="hidden" id="editIndex">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <label>Nombre</label>
        <input id="nombre" type="text">
      </div>
      <div>
        <label>Precio</label>
        <input id="precio" type="text" placeholder="Ej: 3400 (sin $)">
      </div>

      <div style="grid-column:1/3">
        <label>Descripci√≥n</label>
        <textarea id="descripcion" rows="3"></textarea>
      </div>

      <div>
        <label>Imagen (ruta o URL)</label>
        <input id="imagen" type="text" oninput="previewImage()">
        <img id="preview" class="previewImg" style="display:none">
      </div>

      <div>
        <label>Categor√≠a</label>
        <input id="categoria" type="text" placeholder="Ej: Cafeter√≠a">
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px">
      <button type="button" onclick="guardarFormulario()">Guardar</button>
      <button type="button" onclick="cancelForm()" style="background:#999">Cancelar</button>
    </div>
  </form>

  <!-- FORMULARIO M√öLTIPLE -->
  <form id="multiForm" style="display:none">
    <h3>Agregar varios productos</h3>
    <p class="small">Un producto por l√≠nea con formato: <b>nombre | descripcion | precio | imagen | categoria</b></p>
    <textarea id="multiInput" rows="8" placeholder="Ej: Caf√© expresso | Caf√© chico | 3400 | img/cafe.jpg | Cafeter√≠a"></textarea>
    <div style="margin-top:8px;display:flex;gap:8px">
      <button type="button" onclick="procesarMulti()">Guardar varios</button>
      <button type="button" onclick="toggleMultiForm()" style="background:#999">Cerrar</button>
    </div>
  </form>

  <table aria-label="Productos">
    <thead>
      <tr><th style="width:80px">Imagen</th><th>Nombre</th><th>Descripci√≥n</th><th>Categor√≠a</th><th style="width:100px">Precio (ES)</th><th style="width:180px">Acciones</th></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
  /**********************************************************
   * Config (colocadas seg√∫n tu confirmaci√≥n)
   **********************************************************/
  const USERNAME = "cholose10";
  const REPO = "cartaaguero";
  const MAIN_JSON = "productos.json";
  const EN_JSON = "productos-en.json";
  const PT_JSON = "productos-port.json";
  let productos = [];

  /**********************************************************
   * Toast helper (ahora con variantes: ok, info, err)
   **********************************************************/
  function showToast(msg, variant = 'ok', timeout = 3000){
    const div = document.createElement('div');
    div.className = 'toast ' + (variant === 'info' ? 'info' : variant === 'err' ? 'err' : 'ok');
    div.innerText = (variant === 'err' ? '‚úñÔ∏é ' : variant === 'info' ? '‚ÑπÔ∏é ' : '‚úîÔ∏é ') + msg;
    document.body.appendChild(div);
    // show
    requestAnimationFrame(() => div.classList.add('show'));
    setTimeout(() => {
      div.classList.remove('show');
      setTimeout(()=> div.remove(), 300);
    }, timeout);
  }

  /**********************************************************
   * Token (localStorage)
   **********************************************************/
  function saveToken(){
    const t = document.getElementById('token').value.trim();
    if(!t){ showToast('Peg√° tu token primero', 'err'); return; }
    localStorage.setItem('github_token', t);
    document.getElementById('tokenStatus').innerText = 'Token guardado';
    showToast('Token guardado', 'ok', 1800);
  }
  function clearToken(){
    localStorage.removeItem('github_token');
    document.getElementById('tokenStatus').innerText = 'Token borrado';
    showToast('Token borrado', 'info', 1500);
  }
  function getToken(){ return localStorage.getItem('github_token'); }

  // mostrar estado token al cargar
  (function initTokenStatus(){
    const t = getToken();
    if(t) document.getElementById('tokenStatus').innerText = 'Token guardado';
  })();

  /**********************************************************
   * Generador de ID incremental (id + 4 d√≠gitos: id0001)
   **********************************************************/
  function extractNumberFromId(id){
    if(!id) return null;
    const m = String(id).match(/(\d+)\s*$/);
    if(m) return parseInt(m[1], 10);
    return null;
  }

  function generateNextId(){
    let max = 0;
    for(const p of productos){
      const n = extractNumberFromId(p.id || '');
      if(Number.isFinite(n) && n > max) max = n;
    }
    const next = max + 1;
    const s = String(next).padStart(4, '0');
    return 'id' + s;
  }

  /**********************************************************
   * Cargar JSON principal
   **********************************************************/
  async function loadProducts(){
    try{
      const r = await fetch(`https://raw.githubusercontent.com/${USERNAME}/${REPO}/main/${MAIN_JSON}`);
      if(!r.ok) throw new Error(`No se pudo cargar ${MAIN_JSON} (${r.status})`);
      productos = await r.json();
      if(!Array.isArray(productos)) productos = [];
      render(productos);
    }catch(e){
      console.warn(e);
      productos = [];
      render(productos);
      showToast("No se pudo cargar productos.json. Revisa repo o token.", 'err', 5000);
    }
  }

  /**********************************************************
   * Render: filas DOM
   **********************************************************/
  function render(lista){
    const tb = document.getElementById('tbody');
    tb.innerHTML = '';
    lista.forEach((p, i) => {
      const tr = document.createElement('tr');

      // imagen
      const tdImg = document.createElement('td');
      const img = document.createElement('img');
      img.className = 'mini';
      img.src = p.imagen || '';
      img.alt = p.nombre || '';
      img.onerror = () => { img.src = ''; img.style.display = 'none'; };
      tdImg.appendChild(img);
      tr.appendChild(tdImg);

      // nombre
      const tdNombre = document.createElement('td');
      const nombreInput = document.createElement('input');
      nombreInput.type = 'text';
      nombreInput.value = p.nombre || '';
      nombreInput.oninput = (e) => { productos[i].nombre = e.target.value; };
      tdNombre.appendChild(nombreInput);
      tr.appendChild(tdNombre);

      // descripcion
      const tdDesc = document.createElement('td');
      const descTA = document.createElement('textarea');
      descTA.rows = 2;
      descTA.value = p.descripcion || '';
      descTA.oninput = (e) => { productos[i].descripcion = e.target.value; };
      tdDesc.appendChild(descTA);
      tr.appendChild(tdDesc);

      // categoria
      const tdCat = document.createElement('td');
      const catInput = document.createElement('input');
      catInput.type = 'text';
      catInput.value = p.categoria || '';
      catInput.oninput = (e) => { productos[i].categoria = e.target.value; };
      tdCat.appendChild(catInput);
      tr.appendChild(tdCat);

      // precio
      const tdPrecio = document.createElement('td');
      const precioInput = document.createElement('input');
      precioInput.type = 'text';
      precioInput.value = p.precio || '';
      precioInput.oninput = (e) => { productos[i].precio = e.target.value; };
      tdPrecio.appendChild(precioInput);
      tr.appendChild(tdPrecio);

      // acciones
      const tdAcc = document.createElement('td');
      tdAcc.className = 'rowActions';

      const btnGuardar = document.createElement('button');
      btnGuardar.textContent = 'Guardar';
      btnGuardar.onclick = () => guardarFila(i);
      tdAcc.appendChild(btnGuardar);

      const btnEdit = document.createElement('button');
      btnEdit.textContent = 'Editar';
      btnEdit.style.background = '#2d87d6';
      btnEdit.onclick = () => loadIntoForm(i);
      tdAcc.appendChild(btnEdit);

      const btnDelete = document.createElement('button');
      btnDelete.textContent = 'Eliminar';
      btnDelete.className = 'danger';
      btnDelete.onclick = () => eliminarProducto(i);
      tdAcc.appendChild(btnDelete);

      tr.appendChild(tdAcc);
      tb.appendChild(tr);
    });
  }

  /**********************************************************
   * Editar / Agregar formulario
   **********************************************************/
  function toggleForm(){ 
    const f = document.getElementById('form'); 
    f.style.display = f.style.display === 'none' || f.style.display === '' ? 'block' : 'none';
  }
  function cancelForm(){
    document.getElementById('editIndex').value = '';
    document.getElementById('nombre').value = '';
    document.getElementById('descripcion').value = '';
    document.getElementById('precio').value = '';
    document.getElementById('imagen').value = '';
    document.getElementById('categoria').value = '';
    document.getElementById('preview').style.display = 'none';
    document.getElementById('form').style.display = 'none';
  }
  function previewImage(){
    const v = document.getElementById('imagen').value.trim();
    const img = document.getElementById('preview');
    if(!v){ img.style.display='none'; img.src=''; return; }
    img.src = v;
    img.style.display = 'block';
    img.onerror = ()=>{ img.style.display='none'; };
  }

  function loadIntoForm(index){
    const p = productos[index];
    if(!p) return;
    document.getElementById('editIndex').value = index;
    document.getElementById('nombre').value = p.nombre || '';
    document.getElementById('descripcion').value = p.descripcion || '';
    document.getElementById('precio').value = p.precio || '';
    document.getElementById('imagen').value = p.imagen || '';
    document.getElementById('categoria').value = p.categoria || '';
    previewImage();
    document.getElementById('form').style.display = 'block';
  }

  function validarProductoObj(obj){
    if(!obj.nombre) return "Falta nombre";
    if(!obj.precio) return "Falta precio";
    return null;
  }

  function guardarFormulario(){
    const nombre = document.getElementById('nombre').value.trim();
    const descripcion = document.getElementById('descripcion').value.trim();
    const precio = document.getElementById('precio').value.trim();
    const imagen = document.getElementById('imagen').value.trim();
    const categoria = document.getElementById('categoria').value.trim();
    const editIndex = document.getElementById('editIndex').value;

    const obj = { nombre, descripcion, precio, imagen, categoria };

    const err = validarProductoObj(obj);
    if(err){ showToast(err, 'err'); return; }

    if(editIndex !== ''){
      const idx = Number(editIndex);
      productos[idx] = { ...productos[idx], ...obj };
      if(!productos[idx].id) productos[idx].id = generateNextId();
    } else {
      const id = generateNextId();
      productos.push({ id, ...obj });
    }

    render(productos);
    document.getElementById('form').style.display = 'none';
    showToast('Producto agregado/actualizado localmente', 'ok', 1800);
  }

  function toggleMultiForm(){
    const f = document.getElementById('multiForm');
    f.style.display = f.style.display === 'none' || f.style.display === '' ? 'block' : 'none';
  }

  function procesarMulti(){
    const raw = document.getElementById('multiInput').value.trim();
    if(!raw){ showToast('Nada para procesar', 'err'); return; }
    const lines = raw.split('\n').map(l => l.trim()).filter(Boolean);
    for(const ln of lines){
      const parts = ln.split('|').map(p => p.trim());
      const nombre = parts[0] || 'Sin nombre';
      const descripcion = parts[1] || '';
      const precio = parts[2] || '';
      const imagen = parts[3] || '';
      const categoria = parts[4] || '';
      const id = generateNextId();
      productos.push({ id, nombre, descripcion, precio, imagen, categoria });
    }
    document.getElementById('multiInput').value = '';
    render(productos);
    showToast('Productos agregados localmente. Presion√° "Guardar TODOS los cambios".', 'info', 3500);
  }

  /**********************************************************
   * Eliminar producto (local)
   **********************************************************/
  function eliminarProducto(i){
    if(!confirm('Eliminar producto?')) return;
    productos.splice(i,1);
    render(productos);
    showToast('Producto eliminado localmente', 'info', 1600);
  }

  /**********************************************************
   * Guardar fila (especifica) -> guarda MAIN_JSON + sincroniza precios
   **********************************************************/
  async function guardarFila(i){
    try{
      const p = productos[i];
      if(!p) throw new Error('Producto no encontrado');
      if(!p.id) p.id = generateNextId();

      const okMain = await saveToGitHub(MAIN_JSON, productos);
      if(!okMain){ showToast("Error guardando ES (productos.json). Revisa token.", 'err', 5000); return; }

      if(p.id){
        await syncPrice(p.id, p.precio);
      }

      showToast('Cambios guardados correctamente', 'ok', 3000);
      render(productos);
    }catch(e){
      console.error(e);
      showToast('Error guardando fila: ' + (e.message || e), 'err', 5000);
    }
  }

  /**********************************************************
   * Guardar todos -> guarda MAIN_JSON y sincroniza cada precio
   **********************************************************/
  async function guardarTodosLosPrecios(){
    try{
      productos = productos.map(p => p.id ? p : ({ ...p, id: generateNextId() }) );

      const okMain = await saveToGitHub(MAIN_JSON, productos);
      if(!okMain){ showToast("Error guardando ES (productos.json). Revisa token.", 'err', 5000); return; }

      // sincronizar secuencialmente
      for(const p of productos){
        if(p.id) await syncPrice(p.id, p.precio);
      }

      // Mensaje distinto: color azul (info)
      showToast('Cambios guardados correctamente (TODOS)', 'info', 3500);
    }catch(e){
      console.error(e);
      showToast('Error en guardar todos: ' + (e.message || e), 'err', 6000);
    }
  }

  /**********************************************************
   * Sincronizar precios a EN y PT
   **********************************************************/
  async function syncPrice(id, precio){
    if(!id) return;
    await updatePriceInJSON(EN_JSON, id, precio, 'price');
    await updatePriceInJSON(PT_JSON, id, precio, 'preco');
  }

  /**********************************************************
   * Leer archivo desde GitHub API (devuelve {arr, sha})
   **********************************************************/
  async function getFileFromGitHub(file){
    try{
      const token = getToken();
      const headers = token ? { "Authorization": "Bearer " + token, "Accept": "application/vnd.github.v3+json" } : { "Accept": "application/vnd.github.v3+json" };
      const r = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${file}`, { headers });
      if(r.status === 404) return { arr: [], sha: null };
      if(!r.ok) {
        const text = await r.text().catch(()=>'');
        throw new Error(`GitHub GET ${file} failed ${r.status} ${text}`);
      }
      const j = await r.json();
      const decoded = atob(j.content.replace(/\n/g,''));
      const arr = JSON.parse(decoded);
      return { arr: Array.isArray(arr) ? arr : [], sha: j.sha };
    }catch(e){
      console.warn('getFileFromGitHub warning', e);
      return { arr: [], sha: null };
    }
  }

  /**********************************************************
   * updatePriceInJSON: actualizar o crear item en archivo destino (EN/PT)
   **********************************************************/
  async function updatePriceInJSON(file, id, precio, campo){
    try{
      const { arr, sha } = await getFileFromGitHub(file);
      let newArr = Array.isArray(arr) ? arr.slice() : [];

      const ix = newArr.findIndex(x => x && String(x.id) === String(id));
      if(ix >= 0){
        newArr[ix][campo] = precio;
      } else {
        const mainP = productos.find(p => String(p.id) === String(id)) || {};

        if(file === EN_JSON){
          newArr.push({
            id: id,
            name: mainP.nombre || mainP.nome || '',
            description: mainP.descripcion || mainP.descricao || '',
            price: precio,
            image: mainP.imagen || mainP.imagem || ''
          });
        } else if(file === PT_JSON){
          newArr.push({
            id: id,
            nome: mainP.nombre || mainP.nome || '',
            descricao: mainP.descripcion || mainP.descricao || '',
            preco: precio,
            imagem: mainP.imagen || mainP.imagem || ''
          });
        } else {
          newArr.push({ id: id, [campo]: precio });
        }
      }

      const ok = await saveToGitHub(file, newArr, sha);
      if(!ok) showToast(`No se pudo guardar ${file}`, 'err', 4000);
    }catch(e){
      console.error('updatePriceInJSON error', e);
      showToast(`Error actualizando ${file}`, 'err', 4000);
    }
  }

  /**********************************************************
   * saveToGitHub: guarda/crea archivo en GitHub (usa sha si se pasa)
   **********************************************************/
  async function saveToGitHub(file, data, sha = undefined){
    try{
      const token = getToken();
      if(!token){
        showToast('Necesitas pegar tu token de GitHub para poder guardar.', 'err', 4000);
        return false;
      }

      // body.content debe ser base64 (UTF-8 safe)
      const contentB64 = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));

      const body = {
        message: `update ${file}`,
        content: contentB64
      };
      if(sha) body.sha = sha;

      const r = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${file}`, {
        method: 'PUT',
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json",
          "Accept":"application/vnd.github.v3+json"
        },
        body: JSON.stringify(body)
      });

      if(r.status === 200 || r.status === 201) {
        return true;
      } else {
        const respText = await r.text().catch(()=>'');
        console.error('GitHub API error', r.status, respText);
        return false;
      }
    }catch(e){
      console.error('saveToGitHub error', e);
      return false;
    }
  }

  /**********************************************************
   * B√∫squeda / filtro
   **********************************************************/
  function filterProducts(){
    const q = document.getElementById('search').value.trim().toLowerCase();
    if(!q){ render(productos); return; }
    const filtered = productos.filter(p => (p.nombre||'').toLowerCase().includes(q) || (p.descripcion||'').toLowerCase().includes(q) || (p.categoria||'').toLowerCase().includes(q));
    render(filtered);
  }

  /**********************************************************
   * Inicio
   **********************************************************/
  loadProducts();

  </script>

</body>
</html>
