<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Carta - Tilo CafÃ© Aguero</title>

<style>
body{font-family:Arial,Helvetica,sans-serif;margin:18px;background:#f7f3f0;color:#333}
h1{text-align:center;color:#806250}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ddd;padding:8px}
th{background:#806250;color:#fff}
img.mini{max-width:60px;border-radius:6px}
button{background:#806250;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
.toast{position:fixed;top:20px;right:20px;padding:10px 14px;border-radius:8px;color:#fff;font-weight:600;opacity:0;transition:.3s}
.toast.show{opacity:1}
.toast.ok{background:#2ecc71}
.toast.err{background:#e74c3c}
#guardarTodos{position:fixed;top:18px;right:18px;z-index:1200}
</style>
</head>

<body>

<h1>Admin Carta â€” Tilo CafÃ© Aguero</h1>
<button id="guardarTodos" onclick="guardarTodosLosPrecios()">ðŸ’¾ Guardar TODOS</button>

<table>
<thead>
<tr>
<th>Imagen</th>
<th>Nombre</th>
<th>DescripciÃ³n</th>
<th>CategorÃ­a</th>
<th>Precio</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
/* ================= CONFIG ================= */
const USERNAME = "tilo-restocafe";
const REPO = "cartaaguero";
const BRANCH = "main";

const MAIN_JSON = "productos.json";
const EN_JSON   = "productos-en.json";
const PT_JSON   = "productos-port.json";

let productos = [];

/* ================= UTIL ================= */
function showToast(msg,type='ok'){
  const t=document.createElement('div');
  t.className='toast '+type;
  t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.classList.add('show'),50);
  setTimeout(()=>t.remove(),3000);
}
function sanitizePrice(v){
  return String(v||'').replace(/[^\d]/g,'');
}
function getToken(){
  return localStorage.getItem('github_token');
}

/* ================= LOAD ================= */
async function loadProducts(){
  const r = await fetch(`https://raw.githubusercontent.com/${USERNAME}/${REPO}/${BRANCH}/${MAIN_JSON}`);
  productos = await r.json();
  render();
}

/* ================= RENDER ================= */
function render(){
  const tb=document.getElementById('tbody');
  tb.innerHTML='';
  productos.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><img class="mini" src="${p.imagen||''}"></td>
      <td><input value="${p.nombre||''}" oninput="p.nombre=this.value"></td>
      <td><input value="${p.descripcion||''}" oninput="p.descripcion=this.value"></td>
      <td><input value="${p.categoria||''}" oninput="p.categoria=this.value"></td>
      <td><input value="${p.precio||''}" oninput="p.precio=this.value"></td>
      <td><button onclick="guardarFilaPorId('${p.id}')">Guardar</button></td>
    `;
    tb.appendChild(tr);
  });
}

/* ================= GITHUB ================= */
async function githubGet(path){
  const r=await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}?ref=${BRANCH}`,{
    headers:{Authorization:'token '+getToken()}
  });
  return r.json();
}
async function githubPut(path,content,msg,sha){
  await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}`,{
    method:'PUT',
    headers:{
      Authorization:'token '+getToken(),
      'Content-Type':'application/json'
    },
    body:JSON.stringify({
      message:msg,
      content:btoa(unescape(encodeURIComponent(content))),
      sha,
      branch:BRANCH
    })
  });
}

/* ================= SAVE ES ================= */
async function saveMainJson(){
  const info=await githubGet(MAIN_JSON);
  await githubPut(
    MAIN_JSON,
    JSON.stringify(productos,null,2),
    'Actualiza productos',
    info.sha
  );
}

/* ================= SYNC PRECIOS ================= */
async function syncPricesToLangs(){
  const byId={};
  productos.forEach(p=>byId[p.id]=sanitizePrice(p.precio));

  async function sync(file,key){
    const info=await githubGet(file);
    const arr=JSON.parse(atob(info.content));
    arr.forEach(i=>{
      if(byId[i.id]) i[key]=byId[i.id];
    });
    await githubPut(file,JSON.stringify(arr,null,2),'Sync precios',info.sha);
  }

  await sync(EN_JSON,'price');
  await sync(PT_JSON,'preco');
}

/* ================= ðŸ”¥ SYNC PRECIO + IMAGEN ================= */
async function syncCommonFieldsToLangs(){
  const base={};

  productos.forEach(p=>{
    if(p.id){
      base[p.id]={precio:sanitizePrice(p.precio),imagen:p.imagen||''};
    }
  });

  async function sync(file,lang){
    const info=await githubGet(file);
    const arr=JSON.parse(atob(info.content));

    arr.forEach(i=>{
      if(base[i.id]){
        const b=base[i.id];

        if(lang==='EN'){
          i.price=b.precio;
          i.image=b.imagen;   // EN
        }
        if(lang==='PT'){
          i.preco=b.precio;
          i.imagem=b.imagen;  // PT
        }
      }
    });

    await githubPut(file,JSON.stringify(arr,null,2),'Sync precio + imagen',info.sha);
  }

  await sync(EN_JSON,'EN');
  await sync(PT_JSON,'PT');
}

/* ================= GUARDAR ================= */
async function guardarFilaPorId(id){
  try{
    const p=productos.find(x=>x.id===id);
    if(!p) throw 'No encontrado';

    p.precio=sanitizePrice(p.precio);

    await saveMainJson();
    await syncPricesToLangs();
    await syncCommonFieldsToLangs();

    showToast('Producto guardado','ok');
    render();
  }catch(e){
    showToast('Error al guardar','err');
  }
}

async function guardarTodosLosPrecios(){
  try{
    productos=productos.map(p=>({...p,precio:sanitizePrice(p.precio)}));

    await saveMainJson();
    await syncPricesToLangs();
    await syncCommonFieldsToLangs();

    showToast('Todo sincronizado','ok');
    render();
  }catch(e){
    showToast('Error al guardar todo','err');
  }
}

/* ================= INIT ================= */
loadProducts();
</script>

</body>
</html>
