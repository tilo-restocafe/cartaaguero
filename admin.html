<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Carta - Tilo Caf√© Ag√ºero</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f3f0; color:#333; }
    h1 { text-align:center; color:#806250; }

    #topBar {
      width: 100%;
      display: flex;
      justify-content: flex-end;
      margin-bottom: 10px;
    }

    #guardarTodos {
      padding:10px 15px; 
      background:#a07b68; 
      color:white; 
      border:none; 
      border-radius:8px; 
      cursor:pointer;
      font-size: 14px;
    }

    #toggleForm { 
      background:#806250; 
      color:white; 
      padding:10px 15px; 
      border-radius:6px; 
      cursor:pointer; 
      margin-bottom:15px; 
      display:inline-block;
    }

    form { display:none; background:#fff; padding:15px; border-radius:10px; margin-bottom:20px; }

    input, textarea { width:100%; padding:8px; margin:7px 0; border-radius:6px; border:1px solid #ccc; }

    table { width:100%; border-collapse:collapse; background:white; }
    th,td { border:1px solid #ddd; padding:8px; }
    th { background:#806250; color:white; }
    button { background:#806250; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
  </style>
</head>

<body>

  <h1>Panel de Administraci√≥n</h1>

  <!-- Barra superior con bot√≥n -->
  <div id="topBar">
    <button id="guardarTodos" onclick="guardarTodosLosPrecios()">üíæ Guardar TODOS los cambios</button>
  </div>

  <div>
    <label>Token:</label>
    <input type="password" id="token" placeholder="Pegar token">
    <button onclick="saveToken()">Guardar</button>
    <button onclick="clearToken()">Borrar</button>
    <p id="tokenStatus"></p>
  </div>

  <input id="search" placeholder="Buscar..." oninput="filterProducts()">

  <button id="toggleForm" onclick="toggleForm()">+ Agregar producto</button>

  <form id="form">
    <input type="hidden" id="editIndex">
    <label>Nombre</label>
    <input id="nombre">

    <label>Descripci√≥n</label>
    <textarea id="descripcion"></textarea>

    <label>Precio</label>
    <input id="precio">

    <label>Imagen (img/...)</label>
    <input id="imagen">
    <img id="preview" style="max-width:100px;margin-top:5px;border-radius:6px;">

    <label>Categor√≠a</label>
    <input id="categoria">

    <button type="button" onclick="guardarFormulario()">Guardar</button>
  </form>

  <table>
    <thead><tr>
      <th>Imagen</th><th>Nombre</th><th>Descripci√≥n</th><th>Categor√≠a</th><th>Precio</th><th>Acciones</th>
    </tr></thead>
    <tbody id="tbody"></tbody>
  </table>

<script>
const USERNAME="cholose10", REPO="cartaaguero";
const MAIN_JSON="productos.json";
const EN_JSON="productos-en.json";
const PT_JSON="productos-port.json";

let productos=[];

// TOKEN
function saveToken(){ localStorage.setItem('github_token', document.getElementById('token').value); document.getElementById('tokenStatus').innerText='Token guardado'; }
function clearToken(){ localStorage.removeItem('github_token'); document.getElementById('tokenStatus').innerText='Token borrado'; }
function getToken(){ return localStorage.getItem('github_token'); }

// CARGAR JSON PRINCIPAL (ES)
async function loadProducts(){
  try{
    const r = await fetch(`https://raw.githubusercontent.com/${USERNAME}/${REPO}/main/${MAIN_JSON}`);
    productos = await r.json();
    render(productos);
  }catch(e){
    console.error(e);
    productos = [];
    render(productos);
  }
}

// DIBUJAR TABLA
function render(lista){
  const tb = document.getElementById('tbody');
  tb.innerHTML = '';

  lista.forEach((p,i)=>{
    tb.innerHTML += `
      <tr>
        <td><img src="${p.imagen||''}" style="max-width:60px;"></td>
        <td><input value="${p.nombre||''}" oninput="editField(${i},'nombre',this.value)"></td>
        <td><textarea oninput="editField(${i},'descripcion',this.value)">${p.descripcion||''}</textarea></td>
        <td><input value="${p.categoria||''}" oninput="editField(${i},'categoria',this.value)"></td>
        <td><input value="${p.precio||''}" oninput="editField(${i},'precio',this.value)"></td>
        <td><button onclick="guardarFila(${i})">Guardar</button></td>
      </tr>`;
  });
}

// EDITAR CAMPOS EN TABLA
function editField(i,campo,valor){ productos[i][campo] = valor; }

// GUARDAR SOLO UNA FILA
async function guardarFila(i){
  const ok = await saveToGitHub(MAIN_JSON, productos);
  if(!ok){ alert("‚ùå Error guardando en espa√±ol"); return; }

  await syncPrice(productos[i].id, productos[i].precio);

  alert("‚úÖ Guardado (ES + EN + PT)");
}

// SINCRONIZAR PRECIOS (ES ‚Üí EN ‚Üí PT)
async function syncPrice(id, precio){
  if(!id) return;
  await updatePriceInJSON(EN_JSON, id, precio, "price");
  await updatePriceInJSON(PT_JSON, id, precio, "preco");
}

// ACTUALIZA PRECIO EN OTROS JSON
async function updatePriceInJSON(file, id, precio, campo){
  try{
    const r = await fetch(`https://raw.githubusercontent.com/${USERNAME}/${REPO}/main/${file}`);
    let arr = await r.json();

    const ix = arr.findIndex(x=>x.id===id);
    if(ix >= 0) arr[ix][campo] = precio;

    await saveToGitHub(file, arr);
  }catch(e){
    console.error(e);
  }
}

// GUARDAR ARCHIVO EN GITHUB
async function saveToGitHub(file, content){
  try{
    const token = getToken();
    if(!token){ alert("‚ùå Falta token"); return false; }

    const sha = await getSHA(file);

    const r = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${file}`,{
      method:'PUT',
      headers:{
        "Content-Type":"application/json",
        "Authorization":"token "+token
      },
      body:JSON.stringify({
        message:"update",
        content:btoa(unescape(encodeURIComponent(JSON.stringify(content,null,2)))),
        sha
      })
    });

    return r.ok;
  }catch(e){
    console.error(e);
    return false;
  }
}

// OBTENER SHA
async function getSHA(file){
  const r = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${file}`);
  const j = await r.json();
  return j.sha;
}

// GUARDAR TODOS LOS PRECIOS
async function guardarTodosLosPrecios(){
  const ok = await saveToGitHub(MAIN_JSON, productos);
  if(!ok){ alert("‚ùå Error guardando espa√±ol"); return; }

  for(const p of productos){
    await syncPrice(p.id, p.precio);
  }

  alert("‚úÖ TODOS los cambios guardados (ES + EN + PT)");
}

// OTROS
function toggleForm(){ const f=document.getElementById('form'); f.style.display = f.style.display==='none'?'block':'none'; }
function previewImage(){ document.getElementById('preview').src = document.getElementById('imagen').value; }
function filterProducts(){ 
  const t=document.getElementById('search').value.toLowerCase();
  render(productos.filter(p=> (p.nombre||'').toLowerCase().includes(t)));
}

loadProducts();
</script>

</body>
</html>
